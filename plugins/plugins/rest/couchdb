################################################################################
#                                         
# |              |    |         |         
# |---.,---.,---.|---.|    ,---.|--- ,---.
# |   |,---|`---.|   ||    |---'|    `---.
# `---'`---^`---'`   '`---'`---'`---'`---'
#
#                                        
# Bashlets -- A modular extensible toolbox for Bash
#
# Copyright (c) 2014-5 Roberto Reale
# 
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# 
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
# 
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
################################################################################


# NOTE: requires curl and python

source bashlet datatype/uuid
source bashlet marshal/uneval


function bashlets_rest_couchdb_get_handler()
{
    uneval create
}

function bashlets_rest_couchdb_release_handler()
{
    :
}

function bashlets_rest_couchdb_get_param()
{
    local handler="$1"
    local key="$2"

    [[ -n $handler && -n $key ]] || return

    echo "$(uneval get_by_key "$handler" "$key")"
}

function bashlets_rest_couchdb_set_param()
{
    local handler="$1"
    local key="$2"
    local value="$3"

    [[ -n $handler && -n $key ]] || return

    uneval add_pair "$handler" "$key" "$value"
}

function bashlets_rest_couchdb_get_schema()
{
    local handler="$1"
    bashlets_rest_couchdb_get_param "$handler" schema
}

function bashlets_rest_couchdb_set_schema()
{
    local handler="$1"
    local schema="$2"
    bashlets_rest_couchdb_set_param "$handler" "schema" "$schema"
}

function bashlets_rest_couchdb_set_schema_default()
{
    local handler="$1"
    bashlets_rest_couchdb_set_schema "$handler" "http"
}

function bashlets_rest_couchdb_get_host()
{
    local handler="$1"
    bashlets_rest_couchdb_get_param "$handler" host
}

function bashlets_rest_couchdb_set_host()
{
    local handler="$1"
    local host="$2"
    bashlets_rest_couchdb_set_param "$handler" "host" "$host"
}

function bashlets_rest_couchdb_set_host_default()
{
    local handler="$1"
    bashlets_rest_couchdb_set_host "$handler" "localhost"
}

function bashlets_rest_couchdb_get_port()
{
    local handler="$1"
    bashlets_rest_couchdb_get_param "$handler" port
}

function bashlets_rest_couchdb_set_port()
{
    local handler="$1"
    local port="$2"
    bashlets_rest_couchdb_set_param "$handler" "port" "$port"
}

function bashlets_rest_couchdb_set_port_default()
{
    local handler="$1"
    bashlets_rest_couchdb_set_port "$handler" 5984
}

function bashlets_rest_couchdb_get_db()
{
    local handler="$1"
    bashlets_rest_couchdb_get_param "$handler" db
}

function bashlets_rest_couchdb_set_db()
{
    local handler="$1"
    local db="$2"
    bashlets_rest_couchdb_set_param "$handler" "db" "$db"
}

function bashlets_rest_couchdb_set_db_default()
{
    local handler="$1"
    bashlets_rest_couchdb_set_db "$handler" "test"
}

function bashlets_rest_couchdb_get_content_type()
{
    local handler="$1"
    bashlets_rest_couchdb_get_param "$handler" content_type
}

function bashlets_rest_couchdb_set_content_type()
{
    local handler="$1"
    local content_type="$2"
    bashlets_rest_couchdb_set_param "$handler" "content_type" "$content_type"
}

function bashlets_rest_couchdb_set_content_type_default()
{
    local handler="$1"
    bashlets_rest_couchdb_set_content_type "$handler" "text/plain"
}

function bashlets_rest_couchdb_set_params_default()
{
    local handler="$1"
    handler=$(bashlets_rest_couchdb_set_schema_default       "$handler")
    handler=$(bashlets_rest_couchdb_set_host_default         "$handler")
    handler=$(bashlets_rest_couchdb_set_port_default         "$handler")
    handler=$(bashlets_rest_couchdb_set_db_default           "$handler")
    handler=$(bashlets_rest_couchdb_set_content_type_default "$handler")
    echo "$handler"
}

function bashlets_rest_couchdb_generate_session_id
{
    uuid create
}

function bashlets_rest_couchdb_create_db()
{
    local handler="$1"
    local schema="$(bashlets_rest_couchdb_get_schema "$handler")"
    local host="$(bashlets_rest_couchdb_get_host     "$handler")"
    local port="$(bashlets_rest_couchdb_get_port     "$handler")"
    local db="$(bashlets_rest_couchdb_get_db         "$handler")"

    [[ -n $schema ]] || return 1
    [[ -n $host   ]] || return 1
    [[ -n $port   ]] || return 1
    [[ -n $db     ]] || return 1

    curl -s -o /dev/null -X PUT "$schema://$host:$port/$db"
}

function bashlets_rest_couchdb_create_session()
{
    local handler="$1"
    local tag="$2"
    local session_id="$(bashlets_rest_couchdb_generate_session_id)"
    local schema="$(bashlets_rest_couchdb_get_schema "$handler")"
    local host="$(bashlets_rest_couchdb_get_host     "$handler")"
    local port="$(bashlets_rest_couchdb_get_port     "$handler")"
    local db="$(bashlets_rest_couchdb_get_db         "$handler")"
    local retcode

    [[ -n $schema ]] || return 1
    [[ -n $host   ]] || return 1
    [[ -n $port   ]] || return 1
    [[ -n $db     ]] || return 1
    [[ -n $tag    ]] || return 1

    curl -s -o /dev/null -X PUT                    \
        "$schema://$host:$port/$db/$session_id"    \
        -d "{\"Title\":\"$tag\"}"

    retcode=$?

    echo "$session_id"
    return $retcode
}

function bashlets_rest_couchdb_get_revision()
{
    local handler="$1"
    local session_id="$2"
    local schema="$(bashlets_rest_couchdb_get_schema "$handler")"
    local host="$(bashlets_rest_couchdb_get_host     "$handler")"
    local port="$(bashlets_rest_couchdb_get_port     "$handler")"
    local db="$(bashlets_rest_couchdb_get_db         "$handler")"
    local revision

    [[ -n $session_id ]] || return 1
    [[ -n $schema     ]] || return 1
    [[ -n $host       ]] || return 1
    [[ -n $port       ]] || return 1
    [[ -n $db         ]] || return 1

    revision="$(curl -s -X GET                     \
        "$schema://$host:$port/$db/$session_id" |  \
        python -c "import sys, json; print json.load(sys.stdin)['_rev']")"

    echo "$revision"
}

function bashlets_rest_couchdb_add_attachment()
{
    local handler="$1"
    local session_id="$2"
    local revision="$3"
    local att_path="$4"
    local att_name="$(basename "$att_path")"
    local schema="$(bashlets_rest_couchdb_get_schema "$handler")"
    local host="$(bashlets_rest_couchdb_get_host     "$handler")"
    local port="$(bashlets_rest_couchdb_get_port     "$handler")"
    local db="$(bashlets_rest_couchdb_get_db         "$handler")"
    local content_type="$(bashlets_rest_couchdb_get_content_type "$handler")"
    local retcode

    [[ -n $session_id   ]] || return 1
    [[ -n $schema       ]] || return 1
    [[ -n $host         ]] || return 1
    [[ -n $port         ]] || return 1
    [[ -n $db           ]] || return 1
    [[ -n $att_name     ]] || return 1
    [[ -n $att_path     ]] || return 1
    [[ -n $content_type ]] || return 1

    curl -s -o /dev/null -X PUT                                          \
        "$schema://$host:$port/$db/$session_id/$att_name?rev=$revision"  \
        --data-binary "@$att_path" -H "Content-Type: $content_type"

    retcode=$?

    echo "$att_name"
    return $retcode
}

function bashlets_rest_couchdb_get_attachment()
{
    local handler="$1"
    local session_id="$2"
    local revision="$3"
    local att_name="$4"
    local att_save_path="$5"
    local schema="$(bashlets_rest_couchdb_get_schema "$handler")"
    local host="$(bashlets_rest_couchdb_get_host     "$handler")"
    local port="$(bashlets_rest_couchdb_get_port     "$handler")"
    local db="$(bashlets_rest_couchdb_get_db         "$handler")"

    [[ -n $session_id    ]] || return 1
    [[ -n $schema        ]] || return 1
    [[ -n $host          ]] || return 1
    [[ -n $port          ]] || return 1
    [[ -n $db            ]] || return 1
    [[ -n $att_name      ]] || return 1
    [[ -n $att_save_path ]] || return 1

    curl -s -o "$att_save_path" -X GET  \
        "$schema://$host:$port/$db/$session_id/$att_name"
}


# Local variables:
# mode: shell-script
# sh-basic-offset: 4
# sh-indent-comment: t
# indent-tabs-mode: nil
# End:
# ex: ts=4 sw=4 et filetype=sh
